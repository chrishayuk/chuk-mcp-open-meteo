"""Open-Meteo MCP Server - The best weather MCP server ever.

Provides comprehensive weather data through multiple tools:
- Weather forecasts (current, hourly, daily)
- Location geocoding
- Historical weather data
- Air quality information
- Marine weather forecasts
"""

import logging
import sys
from typing import Any, Optional

import httpx
from chuk_mcp_server import tool, run

# Configure logging
# In STDIO mode, we need to be quiet to avoid polluting the JSON-RPC stream
# Only log to stderr, and only warnings/errors
logging.basicConfig(
    level=logging.WARNING, format="%(levelname)s:%(name)s:%(message)s", stream=sys.stderr
)
logger = logging.getLogger(__name__)

# Constants
FORECAST_API = "https://api.open-meteo.com/v1/forecast"
GEOCODING_API = "https://geocoding-api.open-meteo.com/v1/search"
HISTORICAL_API = "https://archive-api.open-meteo.com/v1/archive"
AIR_QUALITY_API = "https://air-quality-api.open-meteo.com/v1/air-quality"
MARINE_API = "https://marine-api.open-meteo.com/v1/marine"


@tool
async def get_weather_forecast(
    latitude: float,
    longitude: float,
    temperature_unit: str = "celsius",
    wind_speed_unit: str = "kmh",
    precipitation_unit: str = "mm",
    timezone: str = "auto",
    forecast_days: int = 7,
    current_weather: bool = True,
    hourly: Optional[str] = None,
    daily: Optional[str] = None,
) -> dict[str, Any]:
    """Get comprehensive weather forecast from Open-Meteo API.

    Args:
        latitude: Latitude coordinate (-90 to 90)
        longitude: Longitude coordinate (-180 to 180)
        temperature_unit: Temperature unit - celsius, fahrenheit
        wind_speed_unit: Wind speed unit - kmh, ms, mph, kn
        precipitation_unit: Precipitation unit - mm, inch
        timezone: Timezone (e.g., 'America/New_York', 'auto' for automatic)
        forecast_days: Number of forecast days (1-16)
        current_weather: Include current weather conditions
        hourly: Comma-separated hourly variables (e.g., 'temperature_2m,precipitation,wind_speed_10m')
        daily: Comma-separated daily variables (e.g., 'temperature_2m_max,temperature_2m_min,precipitation_sum')

    Returns:
        Weather forecast data including current conditions and forecasts

    Example hourly variables: temperature_2m, relative_humidity_2m, dew_point_2m, apparent_temperature,
        precipitation, rain, showers, snowfall, snow_depth, weather_code, pressure_msl, surface_pressure,
        cloud_cover, cloud_cover_low, cloud_cover_mid, cloud_cover_high, visibility, evapotranspiration,
        et0_fao_evapotranspiration, vapour_pressure_deficit, wind_speed_10m, wind_speed_80m, wind_speed_120m,
        wind_direction_10m, wind_direction_80m, wind_direction_120m, wind_gusts_10m, soil_temperature_0cm,
        soil_temperature_6cm, soil_moisture_0_to_1cm

    Example daily variables: temperature_2m_max, temperature_2m_min, apparent_temperature_max,
        apparent_temperature_min, precipitation_sum, rain_sum, showers_sum, snowfall_sum,
        precipitation_hours, weather_code, sunrise, sunset, sunshine_duration, daylight_duration,
        wind_speed_10m_max, wind_gusts_10m_max, wind_direction_10m_dominant, shortwave_radiation_sum,
        et0_fao_evapotranspiration
    """
    params = {
        "latitude": latitude,
        "longitude": longitude,
        "temperature_unit": temperature_unit,
        "wind_speed_unit": wind_speed_unit,
        "precipitation_unit": precipitation_unit,
        "timezone": timezone,
        "forecast_days": forecast_days,
    }

    if current_weather:
        params["current_weather"] = "true"

    if hourly:
        params["hourly"] = hourly

    if daily:
        params["daily"] = daily

    async with httpx.AsyncClient() as client:
        response = await client.get(FORECAST_API, params=params, timeout=30.0)
        response.raise_for_status()
        return response.json()


@tool
async def geocode_location(
    name: str,
    count: int = 10,
    language: str = "en",
    format: str = "json",
) -> dict[str, Any]:
    """Search for locations and get their coordinates using Open-Meteo Geocoding API.

    Args:
        name: Location name to search for (e.g., 'London', 'New York', 'Tokyo')
        count: Number of results to return (1-100)
        language: Language code for results (en, de, fr, es, etc.)
        format: Response format (json)

    Returns:
        List of matching locations with coordinates, country, timezone, etc.
        Each result includes: name, latitude, longitude, elevation, country, country_code,
        timezone, population (if available), postcodes (if available)
    """
    params = {
        "name": name,
        "count": count,
        "language": language,
        "format": format,
    }

    async with httpx.AsyncClient() as client:
        response = await client.get(GEOCODING_API, params=params, timeout=30.0)
        response.raise_for_status()
        return response.json()


@tool
async def get_historical_weather(
    latitude: float,
    longitude: float,
    start_date: str,
    end_date: str,
    temperature_unit: str = "celsius",
    wind_speed_unit: str = "kmh",
    precipitation_unit: str = "mm",
    timezone: str = "auto",
    hourly: Optional[str] = None,
    daily: Optional[str] = None,
) -> dict[str, Any]:
    """Get historical weather data from Open-Meteo Archive API.

    Args:
        latitude: Latitude coordinate (-90 to 90)
        longitude: Longitude coordinate (-180 to 180)
        start_date: Start date in YYYY-MM-DD format
        end_date: End date in YYYY-MM-DD format
        temperature_unit: Temperature unit - celsius, fahrenheit
        wind_speed_unit: Wind speed unit - kmh, ms, mph, kn
        precipitation_unit: Precipitation unit - mm, inch
        timezone: Timezone (e.g., 'America/New_York', 'auto' for automatic)
        hourly: Comma-separated hourly variables
        daily: Comma-separated daily variables

    Returns:
        Historical weather data for the specified date range

    Available variables are similar to forecast API.
    Historical data available from 1940 onwards depending on location.
    """
    params = {
        "latitude": latitude,
        "longitude": longitude,
        "start_date": start_date,
        "end_date": end_date,
        "temperature_unit": temperature_unit,
        "wind_speed_unit": wind_speed_unit,
        "precipitation_unit": precipitation_unit,
        "timezone": timezone,
    }

    if hourly:
        params["hourly"] = hourly

    if daily:
        params["daily"] = daily

    async with httpx.AsyncClient() as client:
        response = await client.get(HISTORICAL_API, params=params, timeout=30.0)
        response.raise_for_status()
        return response.json()


@tool
async def get_air_quality(
    latitude: float,
    longitude: float,
    timezone: str = "auto",
    hourly: Optional[str] = None,
    domains: str = "auto",
) -> dict[str, Any]:
    """Get air quality data and forecasts from Open-Meteo Air Quality API.

    Args:
        latitude: Latitude coordinate (-90 to 90)
        longitude: Longitude coordinate (-180 to 180)
        timezone: Timezone (e.g., 'America/New_York', 'auto' for automatic)
        hourly: Comma-separated air quality variables
        domains: Model domain - auto, cams_global, cams_europe

    Returns:
        Air quality data including pollutant concentrations and indices

    Available hourly variables:
    - pm10, pm2_5: Particulate matter (μg/m³)
    - carbon_monoxide, nitrogen_dioxide, sulphur_dioxide, ozone: Gas concentrations (μg/m³)
    - aerosol_optical_depth: Atmospheric aerosol measure
    - dust, uv_index, uv_index_clear_sky: Additional metrics
    - ammonia, alder_pollen, birch_pollen, grass_pollen, mugwort_pollen, olive_pollen, ragweed_pollen
    - european_aqi, european_aqi_pm2_5, european_aqi_pm10, european_aqi_no2, european_aqi_o3, european_aqi_so2
    - us_aqi, us_aqi_pm2_5, us_aqi_pm10, us_aqi_no2, us_aqi_co, us_aqi_o3, us_aqi_so2
    """
    params = {
        "latitude": latitude,
        "longitude": longitude,
        "timezone": timezone,
        "domains": domains,
    }

    if hourly:
        params["hourly"] = hourly
    else:
        # Default to common air quality metrics
        params["hourly"] = (
            "pm10,pm2_5,carbon_monoxide,nitrogen_dioxide,sulphur_dioxide,ozone,us_aqi,european_aqi"
        )

    async with httpx.AsyncClient() as client:
        response = await client.get(AIR_QUALITY_API, params=params, timeout=30.0)
        response.raise_for_status()
        return response.json()


@tool
async def get_marine_forecast(
    latitude: float,
    longitude: float,
    timezone: str = "auto",
    hourly: Optional[str] = None,
    daily: Optional[str] = None,
    forecast_days: int = 7,
) -> dict[str, Any]:
    """Get marine weather forecast from Open-Meteo Marine API.

    Args:
        latitude: Latitude coordinate (-90 to 90)
        longitude: Longitude coordinate (-180 to 180)
        timezone: Timezone (e.g., 'America/New_York', 'auto' for automatic)
        hourly: Comma-separated marine variables
        daily: Comma-separated daily marine variables
        forecast_days: Number of forecast days (1-16)

    Returns:
        Marine weather forecast including wave height, period, direction, and ocean currents

    Available hourly variables:
    - wave_height, wave_direction, wave_period: Wave characteristics
    - wind_wave_height, wind_wave_direction, wind_wave_period, wind_wave_peak_period
    - swell_wave_height, swell_wave_direction, swell_wave_period, swell_wave_peak_period
    - ocean_current_velocity, ocean_current_direction: Current data

    Available daily variables:
    - wave_height_max, wave_direction_dominant, wave_period_max
    - wind_wave_height_max, wind_wave_direction_dominant, wind_wave_period_max
    - swell_wave_height_max, swell_wave_direction_dominant, swell_wave_period_max
    """
    params = {
        "latitude": latitude,
        "longitude": longitude,
        "timezone": timezone,
        "forecast_days": forecast_days,
    }

    if hourly:
        params["hourly"] = hourly
    else:
        # Default to key marine metrics
        params["hourly"] = (
            "wave_height,wave_direction,wave_period,wind_wave_height,swell_wave_height"
        )

    if daily:
        params["daily"] = daily

    async with httpx.AsyncClient() as client:
        response = await client.get(MARINE_API, params=params, timeout=30.0)
        response.raise_for_status()
        return response.json()


def main():
    """Run the Open-Meteo MCP server."""
    # Check if transport is specified in command line args
    # Default to stdio for MCP compatibility (Claude Desktop, mcp-cli)
    transport = "stdio"

    # Allow HTTP mode via command line
    if len(sys.argv) > 1 and sys.argv[1] in ["http", "--http"]:
        transport = "http"
        # Only log in HTTP mode
        logger.warning("Starting Chuk MCP Open-Meteo Server in HTTP mode")

    # Suppress chuk_mcp_server logging in STDIO mode
    if transport == "stdio":
        # Set chuk_mcp_server loggers to ERROR only
        logging.getLogger("chuk_mcp_server").setLevel(logging.ERROR)
        logging.getLogger("chuk_mcp_server.core").setLevel(logging.ERROR)
        logging.getLogger("chuk_mcp_server.stdio_transport").setLevel(logging.ERROR)
        # Suppress httpx logging (API calls)
        logging.getLogger("httpx").setLevel(logging.ERROR)

    run(transport=transport)


if __name__ == "__main__":
    main()
